pipeline {
  agent any

  environment {
      DOCKER_REGISTRY = 'https://registry.hub.docker.com'
      DOCKER_CREDENTIALS = credentials('docker-hub-credentials')
  }
  
   stages {
    stage('building new image') {
      steps {
        sh 'docker build -t dev_img .'
      }
    }
    stage('run containers') {
      steps {
        sh 'docker run -d -p 5000:5000 --name dev_cont dev_img:latest'
      }
    }
    stage('wait for site') {
      steps {
        sleep(10)
      }
    }
    stage('test container') {
      steps {
        sh 'curl http://localhost:5000'
        }
    }
    stage('stop test container') {
      steps {
        sh 'docker stop dev_cont'
        }
    }
    stage('remove test container') {
      steps {
        sh 'docker remove dev_cont'
        }
    }
    stage('docker login') {
      steps {
        sh 'docker login -u "$DOCKER_CREDENTIALS_USR" -p "$DOCKER_CREDENTIALS_PSW"'
        }
    }
    stage('tag new image') {
      steps {
        sh 'docker tag dev_img guylah/final_dev:latest'
        }
    }
    stage('push image to docker hub') {
      steps {
        sh 'docker push guylah/final_dev:latest'
        }
    }
    stage('delete old image') {
      steps {
        sh 'docker rmi dev_img guylah/final_dev:latest' 
        }
    }
  }
}
